image: ruby:2.3

variables:
    JEKYLL_ENV: production
    GIT_SUBMODULE_STRATEGY: recursive

before_script:
    - apt-get -qq update && apt-get -qq install -y tor netcat-openbsd openssh-server openssh-client
    - /etc/init.d/tor start
    - mkdir -p ~/.ssh && touch ~/.ssh/config
    - echo "$PRIVATE_KEY" > ~/.ssh/deploy_key
    - touch ~/.ssh/known_hosts
    - chmod 600 ~/.ssh/known_hosts
    - chmod 600 ~/.ssh/deploy_key
    - echo "StrictHostKeyChecking=no" >> ~/.ssh/config
    - echo "Host *.onion" >> ~/.ssh/config
    - echo "    ProxyCommand /usr/bin/nc -x localhost:9050 %h %p" >> ~/.ssh/config
    - echo "Listing home directory" && ls -la ~
    - echo "Listing SSH directory" && ls -la ~/.ssh
    - echo "Listing current working directory" && ls -la .
    - eval $(ssh-agent)
    - echo "Add deploy key to keychain" && ssh-add ~/.ssh/deploy_key
    - echo "Wait 10 seconds to bootstrap" && sleep 10
    - echo "Making test connection" && ssh -o "ProxyCommand nc -x localhost:9050 %h %p" -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" lncm@nlcnxuehxfppi5y4.onion "uname -a"
    - bundle install
    - git submodule sync --recursive
    - git submodule foreach git pull origin master

test:
    stage: test
    script:
    - bundle exec jekyll build -d test
    artifacts:
        paths:
        - test
    except:
    - master

pages:
    stage: deploy
    script:
    - bundle exec jekyll build -d public
    - echo "Making test deploy" && cd public/ && scp -o "ProxyCommand nc -x localhost:9050 %h %p" -o "StrictHostKeyChecking=no" -o "UserKnownHostsFile=/dev/null" -r * lncm@nlcnxuehxfppi5y4.onion:www-gitlab
    artifacts:
        paths:
        - public
    only:
    - master
